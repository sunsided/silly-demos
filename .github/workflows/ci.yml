name: CI

on:
  push:
  pull_request:

jobs:
  wasm-pack-tests:
    name: wasm-pack (beta) - build & browser tests
    runs-on: ubuntu-latest
    env:
      RUST_BACKTRACE: '1'
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Rust (beta)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: beta
          override: true

      - name: Install helper tools
        run: |
          set -e
          if ! command -v cargo-install-update >/dev/null 2>&1; then cargo install cargo-update; fi
          if ! command -v cargo-generate >/dev/null 2>&1; then cargo install --vers "^0.2" cargo-generate; fi
          cargo install-update -a || true

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh -s -- -f

      - name: Ensure browsers available
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser firefox

      - name: Run wasm-pack build & browser tests
        run: |
          cargo generate --git . --name testing
          mv Cargo.toml Cargo.toml.tmpl || true
          cd testing
          wasm-pack build
          wasm-pack test --chrome --firefox --headless

  checks:
    name: cargo checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        toolchain: [nightly, beta]
    env:
      RUST_BACKTRACE: '1'
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.toolchain }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Rust (matrix)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.toolchain }}
          override: true

      - name: Install helper tools
        run: |
          set -e
          if ! command -v cargo-install-update >/dev/null 2>&1; then cargo install cargo-update; fi
          if ! command -v cargo-generate >/dev/null 2>&1; then cargo install --vers "^0.2" cargo-generate; fi
          cargo install-update -a || true

      - name: Add wasm target
        run: rustup target add wasm32-unknown-unknown || true

      - name: Run cargo checks (various configurations)
        run: |
          set -e
          cargo generate --git . --name testing
          mv Cargo.toml Cargo.toml.tmpl || true
          cd testing

          cargo check
          cargo check --target wasm32-unknown-unknown

          cargo check --no-default-features
          cargo check --target wasm32-unknown-unknown --no-default-features

          cargo check --no-default-features --features console_error_panic_hook
          cargo check --target wasm32-unknown-unknown --no-default-features --features console_error_panic_hook

          cargo check --no-default-features --features "console_error_panic_hook wee_alloc"
          cargo check --target wasm32-unknown-unknown --no-default-features --features "console_error_panic_hook wee_alloc"
