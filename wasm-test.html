<!doctype html>
<html lang="en">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WASM circle collision demo</title>
<style>
    :root {
        /* theme */
        --bg-main: #111;
        --bg-canvas: #181818;
        --fg-text: #ddd;
        --fg-pill-bg: #333;

        /* shared alpha */
        --circle-alpha: 0.6;

        /* circle colors with embedded transparency */
        --circle-a-normal: rgb(46 125 50 / var(--circle-alpha));
        --circle-a-hit: rgb(198 40 40 / var(--circle-alpha));
        --circle-b-normal: rgb(102 187 106 / var(--circle-alpha));
        --circle-b-hit: rgb(239 83 80 / var(--circle-alpha));

        /* connecting line */
        --line-color: #fff;
        --line-style: 3, 6; /* dash pattern: 3px dash, 6px gap */
    }

    html, body {
        height: 100%;
        margin: 0;
        background: var(--bg-main);
        color: var(--fg-text);
        font: 14px/1.3 system-ui, sans-serif;
    }

    #wrap {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 16px;
        height: 100%;
    }

    #side {
        padding: 12px;
    }

    #canvas {
        background: var(--bg-canvas);
        display: block;
        width: 100%;
        height: 100%;
    }

    .stat {
        margin: 6px 0;
    }

    .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        background: var(--fg-pill-bg);
    }
</style>

<div id="wrap">
    <canvas id="canvas" width="900" height="600"></canvas>
    <div id="side">
        <h3>WASM circle collision</h3>
        <div class="stat">Intersect: <span id="inter" class="pill">false</span></div>
        <div class="stat">Distance: <span id="dist" class="pill">0</span></div>
        <div class="stat">Penetration: <span id="pen" class="pill">0</span></div>
        <p>Drag the circles. Colors switch on intersection.<br/>
            Call boundary: <code>circle_collision(x1,y1,r1,x2,y2,r2)</code> (1 call/frame).</p>
    </div>
</div>

<script type="module">
    import init, {run, circle_collision} from "./pkg/silly_demos.js";

    await init();
    await run();

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const interEl = document.getElementById("inter");
    const distEl = document.getElementById("dist");
    const penEl = document.getElementById("pen");

    function setupCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const cw = canvas.clientWidth, ch = canvas.clientHeight;
        const bsW = Math.round(cw * dpr), bsH = Math.round(ch * dpr);
        if (canvas.width !== bsW || canvas.height !== bsH) {
            canvas.width = bsW;
            canvas.height = bsH;
        }
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    setupCanvas();
    window.addEventListener("resize", setupCanvas);

    const A = {x: 280, y: 300, r: 90, offx: 0, offy: 0};
    const B = {x: 560, y: 300, r: 110, offx: 0, offy: 0};

    const pt = (e) => {
        const r = canvas.getBoundingClientRect();
        return {x: e.clientX - r.left, y: e.clientY - r.top};
    };
    const hit = (c, p) => {
        const dx = p.x - c.x, dy = p.y - c.y;
        return dx * dx + dy * dy <= c.r * c.r;
    };

    let dragging = null;
    canvas.addEventListener("pointerdown", (e) => {
        const p = pt(e);
        if (hit(A, p)) {
            dragging = A;
            A.offx = p.x - A.x;
            A.offy = p.y - A.y;
        } else if (hit(B, p)) {
            dragging = B;
            B.offx = p.x - B.x;
            B.offy = p.y - B.y;
        }
        canvas.setPointerCapture(e.pointerId);
    });
    canvas.addEventListener("pointermove", (e) => {
        if (!dragging) return;
        const p = pt(e);
        dragging.x = p.x - dragging.offx;
        dragging.y = p.y - dragging.offy;
    });
    const stopDrag = () => dragging = null;
    canvas.addEventListener("pointerup", stopDrag);
    canvas.addEventListener("pointercancel", stopDrag);
    canvas.addEventListener("pointerleave", stopDrag);

    const cssVar = (n) => getComputedStyle(document.documentElement).getPropertyValue(n).trim();

    function drawCircle(c, fillVar) {
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
        ctx.fillStyle = cssVar(fillVar);
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#ddd";
        ctx.stroke();
    }

    function draw() {
        const res = circle_collision(A.x, A.y, A.r, B.x, B.y, B.r);
        interEl.textContent = res.intersect ? "yes" : "no";
        distEl.textContent = res.distance.toFixed(2);
        penEl.textContent = res.penetration.toFixed(2);

        ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
        drawCircle(A, res.intersect ? "--circle-a-hit" : "--circle-a-normal");
        drawCircle(B, res.intersect ? "--circle-b-hit" : "--circle-b-normal");

        ctx.beginPath();
        ctx.moveTo(A.x, A.y);
        ctx.lineTo(B.x, B.y);
        ctx.strokeStyle = cssVar("--line-color");
        ctx.setLineDash(cssVar("--line-style").split(",").map(parseFloat));
        ctx.stroke();
        ctx.setLineDash([]);

        requestAnimationFrame(draw);
    }

    draw();
</script>

</html>
