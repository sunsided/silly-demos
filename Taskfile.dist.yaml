version: "3"

tasks:

  default:
    cmds:
      - task --list

  rust:build:
    desc: Build WASM
    vars:
      ARGS: ""
    preconditions:
      - sh: command -v wasm-pack
        msg: "wasm-pack is not installed"
    cmds:
      - wasm-pack build --target=web {{.ARGS}}

  wasm:test:
    desc: Run WASM tests
    aliases:
      - test
      - rust:test
    vars:
      ARGS: ""
    preconditions:
      - sh: command -v wasm-pack
        msg: "wasm-pack is not installed"
      - sh: command -v firefox
        msg: "Firefox is required for wasm-pack test --firefox"
    cmds:
      - wasm-pack test --headless --firefox {{.ARGS}}

  serve:
    desc: Serve current directory on a given port
    vars:
      PORT: "{{.PORT}}"
    preconditions:
      - sh: command -v python3
        msg: "python3 is required for serving files"
    cmds:
      - python3 -m http.server {{.PORT}}

  yarn:setup:
    desc: Setup React dependencies
    aliases:
      - yarn:install
    dir: react-app
    preconditions:
      - sh: command -v yarn
        msg: "yarn is not installed"
    cmds:
      - yarn install

  dev:
    desc: Start React dev server
    aliases:
      - yarn:dev
    dir: react-app
    preconditions:
      - sh: command -v yarn
        msg: "yarn is not installed"
    cmds:
      - yarn dev

  yarn:build:
    desc: Build React app
    aliases:
      - react:build
    dir: react-app
    preconditions:
      - sh: command -v yarn
        msg: "yarn is not installed"
    cmds:
      - yarn build

  yarn:preview:
    desc: Preview React production build
    aliases:
      - react:preview
    dir: react-app
    preconditions:
      - sh: command -v yarn
        msg: "yarn is not installed"
    cmds:
      - yarn preview

  yarn:lint:
    desc: Run React TypeScript checks
    aliases:
      - react:lint
    dir: react-app
    preconditions:
      - sh: command -v yarn
        msg: "yarn is not installed"
    cmds:
      - yarn lint

  yarn:build:dev:
    desc: Build WASM + setup + dev
    aliases:
      - react-build-dev
    deps:
      - build
      - yarn:setup
    cmds:
      - task: yarn:dev

  build:
    desc: Build WASM + setup + prod build
    aliases:
      - react:build:full
      - build:react
      - build:react-full
      - react-full-build
    deps:
      - rust:build
      - yarn:setup
    cmds:
      - task: yarn:build

  build:dev:
    desc: Build WASM + setup + prod build
    deps:
      - build
    cmds:
      - task: yarn:dev

  yarn:clean:
    desc: Clean React build artifacts
    aliases:
      - clean:react
      - react:clean
    dir: react-app
    preconditions:
      - sh: command -v rm
        msg: "rm command missing? Something is very wrong."
    cmds:
      - rm -rf dist node_modules yarn.lock
